language: lua

env:
  - LUAJIT_VERSION="master" TEST_BIN="luajit test/tools/run.lua" PRELOAD="libpthread.so.0"
  # - LUAJIT_VERSION="v2.1" TEST_BIN="luajit-2.1.0-alpha test/tools/run.lua" PRELOAD="libpthread.so.0"

# Handle git submodules yourself
git:
  submodules: false

# Use sed to replace the SSH URL with the public URL, then initialize submodules
before_install:
  - sed -i 's/git@github.com:/https:\/\/github.com\//' .gitmodules
  - git submodule update --init --recursive

compiler:
  - gcc

script: # "sudo LUAJIT_VERSION=$LUAJIT_VERSION bash test/tools/install.sh && LD_PRELOAD=\"$PRELOAD\" $TEST_BIN"
  - ./linux quiet mem=2G rootfstype=hostfs rw eth0=slirp,,/usr/bin/slirp-fullbolt init=$(pwd)/bin/travis.sh WORKDIR=$(pwd) HOME=$HOME TEST_BIN=$TEST_BIN PRELOAD=$PRELOAD LUAJIT_VERSION=$LUAJIT_VERSION

branches:
  only:
    - master

install:
  - sudo apt-get install luarocks
  - sudo sh -c "wget -qO- https://get.docker.io/gpg | apt-key add -"
  - sudo sh -c "echo deb http://get.docker.io/ubuntu docker main > /etc/apt/sources.list.d/docker.list"
  - sudo apt-get update
  - sudo mkdir -p /var/lib/docker
  - echo exit 101 | sudo tee /usr/sbin/policy-rc.d
  - sudo chmod +x /usr/sbin/policy-rc.d
  - sudo apt-get install -y slirp lxc lxc-docker aufs-tools cgroup-lite
  - curl -sLo linux https://github.com/jpetazzo/sekexe/raw/master/uml
  - chmod +x linux

notifications:
  recipients:
    - iyatomi+luact.test@gmail.com
  email:
    on_success: change
    on_failure: always
